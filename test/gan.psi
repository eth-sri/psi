// skipped

import genCap;

def max(a,b)â‡’ if a>=b then a else b;

def ganModel(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„, discriminator: â„â†’â„)â‡’
	infer((){
		truth := flip(1/2);
		data := if truth
		        then dataSource()
		        else generator();
		guess := flip(discriminator(data));
		return (truth, guess);
	});


// ganLoss: standard GAN loss
def ganLoss(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„, discriminator: â„â†’â„){
	d := ganModel(dataSource, generator, discriminator);
	return expectation(infer((){ (truth, guess) := sample(d); observe(truth); return log(max(guess,0.001)); }))
		+ expectation(infer((){ (truth, guess) := sample(d); observe(!truth); return log(max(1-guess,0.001)); }));	
}


// ganLoss2: mutual information between truth and discriminator guess
def ganLoss2(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„, discriminator: â„â†’â„)â‡’I(ganModel(dataSource,generator,discriminator),eqâ„,eqâ„);

def bayesianDiscriminator(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„)(x:â„)â‡’
	expectation(infer((){
		truth := flip(1/2);
		data := if truth
		then dataSource()
		else generator();
		observe(data==x);
		return truth;
	}));

def bayesianHardDiscriminator(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„)(x:â„)â‡’
	bayesianDiscriminator(dataSource, generator)(x)>1/2;

def model1(a,b){
	if a<0||b<0||a+b>1 { return 0; }
	def dataSource()â‡’ categorical([1/5,1/3,7/15]); // real data
	def generator()â‡’ categorical([a,b,1-a-b]); // generator, we are optimizing this
	discriminator := makeDiscriminator(dataSource,generator);
	return loss(dataSource,generator,discriminator);	
}

def model2(Î¼){
	def dataSource()â‡’ gauss(0,1); // real data
	def generator()â‡’ gauss(Î¼,1); // generator, we are optimizing this
	// discriminator := makeDiscriminator(dataSource,generator)
	def discriminator(x: â„){
		//return abs(x-Î¼)>abs(x-0);
		return x<0;
	}
	return loss(dataSource,generator,discriminator);
}

def model3(p){
	if p<0||p>1 { return 0; }
	def dataSource()â‡’ flip(1/3);
	def generator()â‡’ flip(p);
	discriminator := makeDiscriminator(dataSource,generator);
	return loss(dataSource,generator,discriminator);
}

def makeDiscriminator(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„)â‡’ bayesianHardDiscriminator(dataSource, generator);
def loss(dataSource: ğŸ™â†’â„, generator: ğŸ™â†’â„, discriminator: â„â†’â„)â‡’ ganLoss2(dataSource,generator,discriminator);

//def main(a,b)â‡’ model1(a,b);
def main(Î¼)â‡’ model2(Î¼);
//def main(p)â‡’ model3(p);
/+
// gan loss illustration:
def main(pâ‚,pâ‚‚){
	if pâ‚<=0||pâ‚‚<=0||pâ‚>=1||pâ‚‚>=1{ return 0; }
	d:=infer((){
		real := flip(1/2);
		guess := if real then pâ‚ else pâ‚‚;
		return (real,guess);
	});
	//return (real,guess);
	return expectation(infer((){ (truth, guess) := sample(d); observe(truth); return log(guess); }))
		+ expectation(infer((){ (truth, guess) := sample(d); observe(!truth); return -log(guess); }));	
}
/+
// gan2 loss illustration:
def main(pâ‚,pâ‚‚){
	if pâ‚<0||pâ‚‚<0||pâ‚>1||pâ‚‚>1{ return 0; }
	d:=infer((){
		real := flip(1/2);
		guess := if real then pâ‚ else pâ‚‚;
		return (real,guess);
	});
	return I(infer((){ (real,guess) := sample(d); guess=flip(guess); return (real,guess); }),eqâ„,eqâ„);
}
+/
+/
